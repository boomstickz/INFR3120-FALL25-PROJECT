<div class="bg-overlay"></div>

<!-- NAVBAR -->
<header class="navbar">

  <div class="logo-area">
    <img src="/img/logo.png" alt="Logo" class="logo">
    <div class="brand-text">
      <h1>Forge My Hero</h1>
      <span class="tagline">Forge your legend from ashes. D&D Character Manager.</span>
    </div>
  </div>

  <nav>
    <% const isLandingNav = typeof landingNav !== 'undefined' ? landingNav : false; %>
    <ul class="nav-links">
      <% if (!currentUser) { %>
        <% if (isLandingNav) { %>
          <li><a href="/about">About</a></li>
          <li><a href="/users/login">Login</a></li>
          <li><a href="/users/register">Register</a></li>
        <% } else { %>
          <li><a href="/">Home</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/users/login">Login</a></li>
          <li><a href="/users/register">Register</a></li>
        <% } %>

      <% } else { %>
        <li class="nav-user">
          <button
            type="button"
            class="nav-avatar-button"
            aria-label="Upload profile picture"
            data-profile-upload
          >
            <img
              src="<%= (currentUser && currentUser.profileImage) ? currentUser.profileImage : '/img/profile-placeholder.svg' %>"
              alt="Profile picture"
              class="nav-avatar"
              data-profile-avatar
            />
          </button>
          <input
            type="file"
            accept="image/*"
            class="visually-hidden"
            data-profile-input
          />
          <span class="nav-username">Hi, <%= currentUser.username %></span>
        </li>
        <li><a href="/characters">Characters</a></li>
        <li><a href="/about">About</a></li>
        <li>
          <form action="/users/logout" method="POST" style="display:inline;">
            <button type="submit" class="logout-btn">Logout</button>
          </form>
        </li>
      <% } %>
      <!-- END AUTH LOGIC -->

    </ul>
  </nav>
</header>

<script>
  (() => {
    const uploadButton = document.querySelector('[data-profile-upload]');
    const fileInput = document.querySelector('[data-profile-input]');
    const avatarImage = document.querySelector('[data-profile-avatar]');

    if (!uploadButton || !fileInput || !avatarImage) {
      return;
    }

    uploadButton.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
      if (!fileInput.files || !fileInput.files.length) {
        return;
      }

      const file = fileInput.files[0];
      const maxSize = 5 * 1024 * 1024;

      if (file.size > maxSize) {
        alert('Please choose an image under 5MB.');
        fileInput.value = '';
        return;
      }

      const reader = new FileReader();

      reader.onload = async () => {
        try {
          uploadButton.setAttribute('aria-busy', 'true');

          const response = await fetch('/users/profile-picture', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ imageData: reader.result }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Unable to upload profile picture.');
          }

          if (data.imageUrl) {
            avatarImage.src = data.imageUrl;
          }
        } catch (err) {
          console.error(err);
          alert(err.message || 'Unable to upload profile picture. Please try again.');
        } finally {
          uploadButton.removeAttribute('aria-busy');
          fileInput.value = '';
        }
      };

      reader.readAsDataURL(file);
    });
  })();
</script>